# ComfyUI Qwen3-VL-Instruct 工具产品文档

## 项目简介

ComfyUI Qwen3-VL-Instruct 是一个专为 ComfyUI 设计的自定义节点扩展，集成了阿里巴巴的 Qwen3-VL（多模态大语言模型），提供强大的图像和视频理解能力。该扩展允许用户通过自然语言指令与图像、视频进行交互，实现高质量的视觉问答、内容描述和多模态分析功能。

## 核心功能

1. **多模态交互**：支持文本、图像、视频的混合输入
2. **视觉问答(VQA)**：对图像和视频内容进行问答
3. **内容描述**：自动生成图像和视频的详细描述
4. **多模型支持**：提供多种 Qwen3-VL 模型变体选择
5. **量化支持**：支持 4bit 和 8bit 量化以减少内存占用
6. **批量处理**：支持同时处理多个媒体文件

## 节点列表

### 1. Qwen3 VQA

这是扩展的核心节点，负责加载和运行 Qwen3-VL 模型进行多模态推理。

**输入参数**：
- `text`：输入文本提示或问题（必填）
- `model`：选择使用的 Qwen3-VL 模型变体（默认已更改为 Huihui-Qwen3-VL-8B-Instruct-abliterated）
- `quantization`：量化选项（none、4bit、8bit）
- `keep_model_loaded`：是否保持模型加载在内存中
- `temperature`：生成温度（0-1，影响输出多样性）
- `max_new_tokens`：最大生成长度
- `min_pixels`/`max_pixels`：处理图像的像素范围设置
- `seed`：随机种子
- `attention`：注意力机制实现方式
- `source_path`：可选的媒体文件路径
- `image`：可选的图像输入
- `use_cache`：缓存开关，默认true。开启时缓存入参与模型输出，参数不变时直接使用缓存结果，节省大模型调用时间

**输出**：
- `STRING`：模型生成的文本回复

### 2. Qwen3 VQA Quick

快捷版的 Qwen3 VQA 节点，支持使用预定义的提示词模板和双图像输入。该节点会直接读取模板文件的原始内容，不进行任何格式解析或处理。

**输入参数**：
- `prompt_template`：提示词模板下拉选择框（从项目的 prompts 文件夹加载，显示的是模板文件的完整文件名）
- `model`：选择使用的 Qwen3-VL 模型变体（默认已更改为 Huihui-Qwen3-VL-8B-Instruct-abliterated）
- `user_prompt`：用户输入的辅助提示词（可选），如果有输入，会在模板文件内容后面追加 "User prompt:输入内容"
- `quantization`：量化选项（none、4bit、8bit）
- `keep_model_loaded`：是否保持模型加载在内存中
- `temperature`：生成温度（0-1，影响输出多样性）
- `max_new_tokens`：最大生成长度
- `min_pixels`/`max_pixels`：处理图像的像素范围设置
- `seed`：随机种子
- `attention`：注意力机制实现方式
- `source_path`：可选的媒体文件路径
- `image1`：第一个图像输入（例如：视频首帧）
- `image2`：第二个图像输入（例如：视频尾帧）
- `use_cache`：缓存开关，默认true。开启时缓存入参与模型输出，参数不变时直接使用缓存结果，节省大模型调用时间

**输出**：
- `STRING`：模型生成的文本回复
- `TEXT`：实际使用的提示词内容

**功能说明**：
- 自动从项目的 prompts 文件夹加载 .txt、.md、.json 格式的提示词模板
- 当选择模板后，自动读取文件内容作为提示词
- 支持双图像输入，特别适合处理视频的首尾帧进行比较分析
- 输出实际使用的提示词内容，便于调试和修改

### 3. Load Image Advanced

高级图像加载器，支持多种图像格式的加载和处理。

**输入参数**：
- `image`：从 ComfyUI 输入目录选择图像文件

**输出**：
- `IMAGE`：加载的图像数据
- `MASK`：对应的掩码数据
- `PATH`：图像文件路径

### 4. Load Video Advanced

高级视频加载器，用于加载视频文件。

**输入参数**：
- `file`：从 ComfyUI 输入目录选择视频文件

**输出**：
- `VIDEO`：加载的视频数据
- `PATH`：视频文件路径

### 5. Load Video Advanced (Path)

基于路径的视频加载器，允许通过直接输入路径加载视频。

**输入参数**：
- `file`：视频文件的路径字符串

**输出**：
- `VIDEO`：加载的视频数据
- `PATH`：视频文件路径

### 6. Multiple Paths Input

多路径输入节点，支持同时处理多个图像或视频路径，实现批处理功能。

**输入参数**：
- `inputcount`：输入路径的数量
- `path_1`/`path_2`...：各个媒体文件的路径
- `sample_fps`：视频采样帧率
- `max_frames`：最大处理帧数
- `use_total_frames`：是否使用视频的全部帧数
- `use_original_fps_as_sample_fps`：是否使用视频原始帧率

**输出**：
- `paths`：组合后的路径列表（JSON 格式）

## 支持的模型

扩展支持多种 Qwen3-VL 模型变体：

1. **Qwen3-VL-4B-Instruct-FP8**：4B 参数的指令调优模型，FP8 精度
2. **Qwen3-VL-4B-Thinking-FP8**：4B 参数的思考型模型，FP8 精度
3. **Qwen3-VL-8B-Instruct-FP8**：8B 参数的指令调优模型，FP8 精度
4. **Qwen3-VL-8B-Thinking-FP8**：8B 参数的思考型模型，FP8 精度
5. **Qwen3-VL-4B-Instruct**：4B 参数的指令调优模型，全精度
6. **Qwen3-VL-4B-Thinking**：4B 参数的思考型模型，全精度
7. **Qwen3-VL-8B-Instruct**：8B 参数的指令调优模型，全精度
8. **Qwen3-VL-8B-Thinking**：8B 参数的思考型模型，全精度
9. **Huihui-Qwen3-VL-8B-Instruct-abliterated**：基于 Qwen3-VL-8B 的修改版本（注意：该模型使用了硬编码路径）

## 技术特点

1. **自动模型下载**：首次使用时自动从 Hugging Face 下载模型
2. **GPU 优化**：自动检测 GPU 能力并选择最佳数据类型（bfloat16/float16）
3. **内存管理**：提供选项释放模型占用的 GPU 内存
4. **灵活配置**：丰富的参数设置，适应不同场景需求
5. **多媒体支持**：同时支持图像和视频输入，适应性强
6. **扩展模型支持**：支持社区修改版本的模型变体

## 工作流程示例

### 1. 单图像问答

1. 使用 Load Image Advanced 节点加载图像
2. 连接到 Qwen3 VQA 节点
3. 在 Qwen3 VQA 节点中输入问题
4. 执行工作流获取回答

### 2. 视频内容分析

1. 使用 Load Video Advanced 或 Load Video Advanced (Path) 加载视频
2. 连接到 Qwen3 VQA 节点
3. 输入分析指令（如"描述这个视频的内容"）
4. 执行工作流获取视频分析结果

### 3. 多图像批处理

1. 使用 Multiple Paths Input 配置多个图像路径
2. 连接到 Qwen3 VQA 节点
3. 输入通用问题或指令
4. 执行工作流获取多个图像的批量分析结果

## 系统要求

1. **硬件要求**：
   - GPU：推荐 NVIDIA GPU 以获得最佳性能
   - 内存：根据选择的模型，至少需要 8GB-24GB GPU 内存
   - 对于量化模型，可以降低内存需求

2. **软件依赖**：
   - Python 3.8+
   - PyTorch 及相关库
   - Transformers 4.57.1+
   - 其他依赖见 requirements.txt

## 安装指南

1. 将项目文件夹放置在 ComfyUI 的 custom_nodes 目录下
2. 安装依赖：
   ```
   pip install -r requirements.txt
   ```
3. 重启 ComfyUI，节点将自动加载

## 常见问题

1. **模型下载失败**：请确保网络连接正常，且有足够的磁盘空间
2. **内存不足错误**：尝试使用量化模型或减小 max_new_tokens 参数
3. **视频处理问题**：确保安装了正确版本的 opencv-python 和 av 库
4. **中文显示问题**：Qwen3-VL 模型原生支持中文，无需额外配置
5. **Huihui 模型路径问题**：Huihui-Qwen3-VL-8B-Instruct-abliterated 模型使用了硬编码路径（Y:\llama-models\Qwen3-vl-nsfw\prompt_generator\Huihui-Qwen3-VL-8B-Instruct-abliterated），如果需要使用此模型，请确保该路径存在或修改代码中的相应路径

## 版本信息

当前版本：1.0.0

## 许可证

MIT License